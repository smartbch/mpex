use std::{collections::HashMap, ops::Add, str::FromStr};

use revm::primitives::{
    alloy_primitives::U160, bitvec::vec, hex::FromHex, ruint::Uint, Address, Bytes, TransactTo,
    TxEnv, U256,
};

use crate::{
    exetask::{READ_SLOT, WRITE_ACC, WRITE_SLOT},
    test_helper::addr_idx_hash,
    utils::addr_to_u256,
};

pub fn create_transfer_token_tx(
    caller: &Address,
    ca_addr: &Address,
    dest: &Address,
    amount: &U256,
    slotmap: &HashMap<Address, U256>,
) -> TxEnv {
    let mut tx = TxEnv::default();
    tx.gas_price = Uint::from(0);
    tx.gas_limit = 2100000;
    tx.caller = caller.clone();
    tx.transact_to = TransactTo::call(ca_addr.clone());
    tx.access_list = vec![(
        WRITE_SLOT,
        vec![
            addr_idx_hash(ca_addr, &slotmap.get(caller).unwrap()),
            addr_idx_hash(ca_addr, &slotmap.get(dest).unwrap()),
        ],
    )];
    let mut data = vec![0xa9, 0x05, 0x9c, 0xbb]; // ERC-20 transfer function selector
    data.extend_from_slice(&vec![0; 12]);
    data.extend_from_slice(&dest.as_slice());
    data.extend_from_slice(&amount.to_be_bytes_vec());
    tx.data = data.into();

    tx
}

/*
contract TestERC20 is ERC20 {
    uint8 private _decimals;

    constructor(
    ) payable ERC20("name_", "symbol_") {
        init(1, 20001, 1_000_000_000_000);
    }

    function mint(address account, uint256 amount) public payable {
        _mint(account, amount);
    }

    function init (
        uint160 addressStart,
        uint160 addressEnd,
        uint256 perValue
    )  public payable {
        for (uint160 i = addressStart; i < addressEnd; i++) {
            address  receivcer =  address(i);
            mint(receivcer, 10000000+i);
            payable(receivcer).call{value: perValue}("");
        }
    }

    function decimals() public view override returns (uint8) {
        return _decimals;
    }
}
*/

pub fn create_deploy_and_transfer_tx() -> TxEnv {
    let mut tx = TxEnv::default();
    tx.gas_price = Uint::from(1);
    tx.gas_limit = 21000000000000000;
    tx.caller = Address::from(U160::MAX);
    tx.transact_to = TransactTo::create();
    let erc20_deploy_hex ="0x60806040526040518060400160405280600581526020017f6e616d655f0000000000000000000000000000000000000000000000000000008152506040518060400160405280600781526020017f73796d626f6c5f000000000000000000000000000000000000000000000000008152508160039081620000819190620005c0565b508060049081620000939190620005c0565b505050620000b16001614e2164e8d4a51000620000b760201b60201c565b620008e2565b60008390505b8273ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff161015620001b35760008190506200012f8183629896806200010d9190620006f6565b73ffffffffffffffffffffffffffffffffffffffff16620001b960201b60201c565b8073ffffffffffffffffffffffffffffffffffffffff168360405162000155906200077c565b60006040518083038185875af1925050503d806000811462000194576040519150601f19603f3d011682016040523d82523d6000602084013e62000199565b606091505b505050508080620001aa9062000793565b915050620000bd565b50505050565b620001cb8282620001cf60201b60201c565b5050565b600073ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff160362000241576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401620002389062000835565b60405180910390fd5b62000255600083836200033c60201b60201c565b806002600082825462000269919062000857565b92505081905550806000808473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600082825401925050819055508173ffffffffffffffffffffffffffffffffffffffff16600073ffffffffffffffffffffffffffffffffffffffff167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef836040516200031c9190620008c5565b60405180910390a362000338600083836200034160201b60201c565b5050565b505050565b505050565b600081519050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b60006002820490506001821680620003c857607f821691505b602082108103620003de57620003dd62000380565b5b50919050565b60008190508160005260206000209050919050565b60006020601f8301049050919050565b600082821b905092915050565b600060088302620004487fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff8262000409565b62000454868362000409565b95508019841693508086168417925050509392505050565b6000819050919050565b6000819050919050565b6000620004a16200049b62000495846200046c565b62000476565b6200046c565b9050919050565b6000819050919050565b620004bd8362000480565b620004d5620004cc82620004a8565b84845462000416565b825550505050565b600090565b620004ec620004dd565b620004f9818484620004b2565b505050565b5b81811015620005215762000515600082620004e2565b600181019050620004ff565b5050565b601f82111562000570576200053a81620003e4565b6200054584620003f9565b8101602085101562000555578190505b6200056d6200056485620003f9565b830182620004fe565b50505b505050565b600082821c905092915050565b6000620005956000198460080262000575565b1980831691505092915050565b6000620005b0838362000582565b9150826002028217905092915050565b620005cb8262000346565b67ffffffffffffffff811115620005e757620005e662000351565b5b620005f38254620003af565b6200060082828562000525565b600060209050601f83116001811462000638576000841562000623578287015190505b6200062f8582620005a2565b8655506200069f565b601f1984166200064886620003e4565b60005b8281101562000672578489015182556001820191506020850194506020810190506200064b565b868310156200069257848901516200068e601f89168262000582565b8355505b6001600288020188555050505b505050505050565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b60006200070382620006a7565b91506200071083620006a7565b92508273ffffffffffffffffffffffffffffffffffffffff038211156200073c576200073b620006c7565b5b828201905092915050565b600081905092915050565b50565b60006200076460008362000747565b9150620007718262000752565b600082019050919050565b6000620007898262000755565b9150819050919050565b6000620007a082620006a7565b915073ffffffffffffffffffffffffffffffffffffffff8203620007c957620007c8620006c7565b5b600182019050919050565b600082825260208201905092915050565b7f45524332303a206d696e7420746f20746865207a65726f206164647265737300600082015250565b60006200081d601f83620007d4565b91506200082a82620007e5565b602082019050919050565b6000602082019050818103600083015262000850816200080e565b9050919050565b600062000864826200046c565b915062000871836200046c565b9250827fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff03821115620008a957620008a8620006c7565b5b828201905092915050565b620008bf816200046c565b82525050565b6000602082019050620008dc6000830184620008b4565b92915050565b61175380620008f26000396000f3fe6080604052600436106100c25760003560e01c8063395093511161007f57806395d89b411161005957806395d89b4114610274578063a457c2d71461029f578063a9059cbb146102dc578063dd62ed3e14610319576100c2565b806339509351146101de57806340c10f191461021b57806370a0823114610237576100c2565b806306fdde03146100c7578063074cd4a0146100f2578063095ea7b31461010e57806318160ddd1461014b57806323b872dd14610176578063313ce567146101b3575b600080fd5b3480156100d357600080fd5b506100dc610356565b6040516100e99190610e57565b60405180910390f35b61010c60048036038101906101079190610f00565b6103e8565b005b34801561011a57600080fd5b5061013560048036038101906101309190610f91565b6104d8565b6040516101429190610fec565b60405180910390f35b34801561015757600080fd5b506101606104fb565b60405161016d9190611016565b60405180910390f35b34801561018257600080fd5b5061019d60048036038101906101989190611031565b610505565b6040516101aa9190610fec565b60405180910390f35b3480156101bf57600080fd5b506101c8610534565b6040516101d591906110a0565b60405180910390f35b3480156101ea57600080fd5b5061020560048036038101906102009190610f91565b61054b565b6040516102129190610fec565b60405180910390f35b61023560048036038101906102309190610f91565b610582565b005b34801561024357600080fd5b5061025e600480360381019061025991906110bb565b610590565b60405161026b9190611016565b60405180910390f35b34801561028057600080fd5b506102896105d8565b6040516102969190610e57565b60405180910390f35b3480156102ab57600080fd5b506102c660048036038101906102c19190610f91565b61066a565b6040516102d39190610fec565b60405180910390f35b3480156102e857600080fd5b5061030360048036038101906102fe9190610f91565b6106e1565b6040516103109190610fec565b60405180910390f35b34801561032557600080fd5b50610340600480360381019061033b91906110e8565b610704565b60405161034d9190611016565b60405180910390f35b60606003805461036590611157565b80601f016020809104026020016040519081016040528092919081815260200182805461039190611157565b80156103de5780601f106103b3576101008083540402835291602001916103de565b820191906000526020600020905b8154815290600101906020018083116103c157829003601f168201915b5050505050905090565b60008390505b8273ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff1610156104d257600081905061045581836298968061043a91906111b7565b73ffffffffffffffffffffffffffffffffffffffff16610582565b8073ffffffffffffffffffffffffffffffffffffffff168360405161047990611232565b60006040518083038185875af1925050503d80600081146104b6576040519150601f19603f3d011682016040523d82523d6000602084013e6104bb565b606091505b5050505080806104ca90611247565b9150506103ee565b50505050565b6000806104e361078b565b90506104f0818585610793565b600191505092915050565b6000600254905090565b60008061051061078b565b905061051d85828561095c565b6105288585856109e8565b60019150509392505050565b6000600560009054906101000a900460ff16905090565b60008061055661078b565b90506105778185856105688589610704565b6105729190611283565b610793565b600191505092915050565b61058c8282610c5e565b5050565b60008060008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020549050919050565b6060600480546105e790611157565b80601f016020809104026020016040519081016040528092919081815260200182805461061390611157565b80156106605780601f1061063557610100808354040283529160200191610660565b820191906000526020600020905b81548152906001019060200180831161064357829003601f168201915b5050505050905090565b60008061067561078b565b905060006106838286610704565b9050838110156106c8576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016106bf9061134b565b60405180910390fd5b6106d58286868403610793565b60019250505092915050565b6000806106ec61078b565b90506106f98185856109e8565b600191505092915050565b6000600160008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054905092915050565b600033905090565b600073ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff1603610802576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016107f9906113dd565b60405180910390fd5b600073ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff1603610871576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016108689061146f565b60405180910390fd5b80600160008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020819055508173ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff167f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b9258360405161094f9190611016565b60405180910390a3505050565b60006109688484610704565b90507fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff81146109e257818110156109d4576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016109cb906114db565b60405180910390fd5b6109e18484848403610793565b5b50505050565b600073ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff1603610a57576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610a4e9061156d565b60405180910390fd5b600073ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff1603610ac6576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610abd906115ff565b60405180910390fd5b610ad1838383610db4565b60008060008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054905081811015610b57576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610b4e90611691565b60405180910390fd5b8181036000808673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002081905550816000808573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600082825401925050819055508273ffffffffffffffffffffffffffffffffffffffff168473ffffffffffffffffffffffffffffffffffffffff167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef84604051610c459190611016565b60405180910390a3610c58848484610db9565b50505050565b600073ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff1603610ccd576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610cc4906116fd565b60405180910390fd5b610cd960008383610db4565b8060026000828254610ceb9190611283565b92505081905550806000808473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600082825401925050819055508173ffffffffffffffffffffffffffffffffffffffff16600073ffffffffffffffffffffffffffffffffffffffff167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef83604051610d9c9190611016565b60405180910390a3610db060008383610db9565b5050565b505050565b505050565b600081519050919050565b600082825260208201905092915050565b60005b83811015610df8578082015181840152602081019050610ddd565b83811115610e07576000848401525b50505050565b6000601f19601f8301169050919050565b6000610e2982610dbe565b610e338185610dc9565b9350610e43818560208601610dda565b610e4c81610e0d565b840191505092915050565b60006020820190508181036000830152610e718184610e1e565b905092915050565b600080fd5b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b610ea781610e7e565b8114610eb257600080fd5b50565b600081359050610ec481610e9e565b92915050565b6000819050919050565b610edd81610eca565b8114610ee857600080fd5b50565b600081359050610efa81610ed4565b92915050565b600080600060608486031215610f1957610f18610e79565b5b6000610f2786828701610eb5565b9350506020610f3886828701610eb5565b9250506040610f4986828701610eeb565b9150509250925092565b6000610f5e82610e7e565b9050919050565b610f6e81610f53565b8114610f7957600080fd5b50565b600081359050610f8b81610f65565b92915050565b60008060408385031215610fa857610fa7610e79565b5b6000610fb685828601610f7c565b9250506020610fc785828601610eeb565b9150509250929050565b60008115159050919050565b610fe681610fd1565b82525050565b60006020820190506110016000830184610fdd565b92915050565b61101081610eca565b82525050565b600060208201905061102b6000830184611007565b92915050565b60008060006060848603121561104a57611049610e79565b5b600061105886828701610f7c565b935050602061106986828701610f7c565b925050604061107a86828701610eeb565b9150509250925092565b600060ff82169050919050565b61109a81611084565b82525050565b60006020820190506110b56000830184611091565b92915050565b6000602082840312156110d1576110d0610e79565b5b60006110df84828501610f7c565b91505092915050565b600080604083850312156110ff576110fe610e79565b5b600061110d85828601610f7c565b925050602061111e85828601610f7c565b9150509250929050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b6000600282049050600182168061116f57607f821691505b60208210810361118257611181611128565b5b50919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b60006111c282610e7e565b91506111cd83610e7e565b92508273ffffffffffffffffffffffffffffffffffffffff038211156111f6576111f5611188565b5b828201905092915050565b600081905092915050565b50565b600061121c600083611201565b91506112278261120c565b600082019050919050565b600061123d8261120f565b9150819050919050565b600061125282610e7e565b915073ffffffffffffffffffffffffffffffffffffffff820361127857611277611188565b5b600182019050919050565b600061128e82610eca565b915061129983610eca565b9250827fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff038211156112ce576112cd611188565b5b828201905092915050565b7f45524332303a2064656372656173656420616c6c6f77616e63652062656c6f7760008201527f207a65726f000000000000000000000000000000000000000000000000000000602082015250565b6000611335602583610dc9565b9150611340826112d9565b604082019050919050565b6000602082019050818103600083015261136481611328565b9050919050565b7f45524332303a20617070726f76652066726f6d20746865207a65726f2061646460008201527f7265737300000000000000000000000000000000000000000000000000000000602082015250565b60006113c7602483610dc9565b91506113d28261136b565b604082019050919050565b600060208201905081810360008301526113f6816113ba565b9050919050565b7f45524332303a20617070726f766520746f20746865207a65726f20616464726560008201527f7373000000000000000000000000000000000000000000000000000000000000602082015250565b6000611459602283610dc9565b9150611464826113fd565b604082019050919050565b600060208201905081810360008301526114888161144c565b9050919050565b7f45524332303a20696e73756666696369656e7420616c6c6f77616e6365000000600082015250565b60006114c5601d83610dc9565b91506114d08261148f565b602082019050919050565b600060208201905081810360008301526114f4816114b8565b9050919050565b7f45524332303a207472616e736665722066726f6d20746865207a65726f20616460008201527f6472657373000000000000000000000000000000000000000000000000000000602082015250565b6000611557602583610dc9565b9150611562826114fb565b604082019050919050565b600060208201905081810360008301526115868161154a565b9050919050565b7f45524332303a207472616e7366657220746f20746865207a65726f206164647260008201527f6573730000000000000000000000000000000000000000000000000000000000602082015250565b60006115e9602383610dc9565b91506115f48261158d565b604082019050919050565b60006020820190508181036000830152611618816115dc565b9050919050565b7f45524332303a207472616e7366657220616d6f756e742065786365656473206260008201527f616c616e63650000000000000000000000000000000000000000000000000000602082015250565b600061167b602683610dc9565b91506116868261161f565b604082019050919050565b600060208201905081810360008301526116aa8161166e565b9050919050565b7f45524332303a206d696e7420746f20746865207a65726f206164647265737300600082015250565b60006116e7601f83610dc9565b91506116f2826116b1565b602082019050919050565b60006020820190508181036000830152611716816116da565b905091905056fea2646970667358221220df1504df69cd4c77b696b4ae63a387c1fcdf5e340d854c3d2f651ddbef8742fa64736f6c634300080f0033";

    tx.data = Bytes::from_hex(erc20_deploy_hex).unwrap();
    tx
}
